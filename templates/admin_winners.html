<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ site_name }} - Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø­ÙŠÙ†</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">

  <style>
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);font-weight:900;text-decoration:none;color:inherit
    }
    .chip.active{border-color:rgba(245,196,0,.40);background:rgba(245,196,0,.10);color:#f5c400}
    .badge{
      padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06)
    }
    .badge.ok{border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.10)}
    .badge.err{border-color:rgba(248,113,113,.35);background:rgba(248,113,113,.10)}
    .btn{
      padding:10px 12px;border-radius:14px;font-weight:900;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);color:inherit;cursor:pointer
    }
    .btn.primary{border-color:rgba(245,196,0,.35);background:rgba(245,196,0,.12);color:#f5c400}

    /* Modal */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;
      align-items:center;justify-content:center;z-index:9999;padding:14px
    }
    .modal{
      width:min(420px,100%);
      border-radius:18px;border:1px solid rgba(255,255,255,.10);
      background:#0f1b2c;box-shadow:0 20px 60px rgba(0,0,0,.45);
      padding:14px
    }
    .modal h3{margin:0;font-size:18px}
    .modal p{margin:10px 0 0 0;opacity:.85;white-space:pre-line}
    .modal-actions{display:flex;gap:10px;justify-content:flex-start;margin-top:14px}
  </style>
</head>
<body>
  <div class="mobile-wrap">

    <div class="top-card">
      <div class="badge-icon">ğŸ†</div>
      <div style="margin-top:10px;">
        <div class="page-title">Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø­ÙŠÙ†</div>
        <div class="page-subtitle">ØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† / Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
      </div>

      <!-- Ø§Ù„ÙÙ„Ø§ØªØ± (ÙÙ‚Ø· Ø§Ø«Ù†ÙŠÙ†) -->
      <div class="filters">
        <a class="chip {{ 'active' if status_filter=='pending' else '' }}"
           href="{{ url_for('admin_winners', status='pending') }}">ØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†</a>

        <a class="chip {{ 'active' if status_filter=='delivered' else '' }}"
           href="{{ url_for('admin_winners', status='delivered') }}">Ø§Ù„Ù…Ø³ØªÙ„Ù…</a>
      </div>

      <div style="margin-top:10px;">
        <a href="{{ url_for('admin_dashboard') }}" style="color:var(--muted);text-decoration:none;font-weight:800;">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£Ø¯Ù…Ù†</a>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ({{ winners|length }})</div>

      {% if winners|length == 0 %}
        <div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</div>
      {% endif %}

      {% for w in winners %}
        <div class="quick-item" style="padding:12px; text-align:right; display:flex; align-items:center; gap:12px;">

          <!-- ØµÙˆØ±Ø© Ø§Ù„Ù‡Ø¯ÙŠØ© -->
          <div style="width:52px;height:52px;border-radius:14px;overflow:hidden;flex:0 0 52px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;">
            {% set img = gift_image_url(w.image_filename) if w.image_filename else None %}
            {% if img %}
              <img src="{{ img }}" alt="gift" style="width:100%;height:100%;object-fit:cover;">
            {% else %}
              <span style="opacity:.6;font-size:22px;">ğŸ</span>
            {% endif %}
          </div>

          <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
          <div style="flex:1;">
            <div style="font-weight:900;">ğŸ‘¤ {{ w.tech_name }}</div>
            <div class="muted small" style="margin-top:6px;">ğŸ {{ w.gift_name }}</div>
            <div class="muted small" style="margin-top:6px;">ğŸ“… {{ w.won_at }}</div>

            {% if (w.status or 'pending') == 'delivered' %}
              <div style="margin-top:8px;"><span class="badge ok">âœ… Ù…Ø³ØªÙ„Ù…</span></div>
            {% else %}
              <div style="margin-top:8px;"><span class="badge err">â³ ØºÙŠØ± Ù…Ø³ØªÙ„Ù…</span></div>
            {% endif %}
          </div>

          <!-- Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„ØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†) -->
          {% if (w.status or 'pending') == 'pending' %}
            <button
              class="btn primary"
              type="button"
              onclick="openConfirm('{{ w.redemption_id }}', '{{ w.tech_name|e }}', '{{ w.gift_name|e }}')">
              ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
            </button>
          {% endif %}

        </div>
      {% endfor %}
    </div>

  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" onclick="closeConfirm(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3 id="modalTitle">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h3>
      <p id="modalText"></p>
      <div class="modal-actions">
        <button class="btn" type="button" onclick="hideModal()">Ø¥Ù„ØºØ§Ø¡</button>

        <form id="confirmForm" method="post">
          <button class="btn primary" type="submit" id="confirmBtn">Ù†Ø¹Ù…ØŒ ØªØ£ÙƒÙŠØ¯</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    function openConfirm(id, techName, giftName){
      const backdrop = document.getElementById('modalBackdrop');
      const text = document.getElementById('modalText');
      const form = document.getElementById('confirmForm');

      text.textContent = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…ØŸ\nØ§Ù„Ø±Ø§Ø¨Ø­: ${techName}\nØ§Ù„Ù‡Ø¯ÙŠØ©: ${giftName}`;

      // Route Ø§Ù„Ø¬Ø¯ÙŠØ¯: ÙŠØ­ÙˆÙ‘Ù„ ÙÙ‚Ø· Ù…Ù† pending Ø¥Ù„Ù‰ delivered
      form.action = `/admin/redemptions/${id}/deliver`;

      backdrop.style.display = 'flex';
    }

    function hideModal(){
      document.getElementById('modalBackdrop').style.display = 'none';
    }

    function closeConfirm(e){
      if(e.target.id === 'modalBackdrop') hideModal();
    }
  </script>
</body>
</html>
