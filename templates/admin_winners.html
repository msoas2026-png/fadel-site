<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ site_name }} - Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø­ÙŠÙ†</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">

  <style>
    /* Tabs using your theme look */
    .tabs-wrap{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .tab-btn{
      flex:1;
      text-align:center;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      text-decoration:none;
      font-weight:900;
    }
    .tab-btn.active{
      background: rgba(245,196,0,.12);
      border-color: rgba(245,196,0,.25);
      color: var(--yellow);
    }

    /* Winner card layout (override center) */
    .winner-row{
      text-align:right;
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }
    .winner-info{
      flex:1;
      min-width:0;
    }
    .winner-name{
      font-weight:900;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .winner-line{
      margin-top:6px;
      color: var(--muted);
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Status pill */
    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      margin-top:10px;
      width: fit-content;
    }
    .status-pill.pending{
      border-color: rgba(248,113,113,.28);
      background: rgba(248,113,113,.10);
      color: #ffb3b3;
    }
    .status-pill.delivered{
      border-color: rgba(34,197,94,.25);
      background: rgba(34,197,94,.10);
      color: #aaffc3;
    }

    /* Right actions */
    .winner-actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-start;
      flex:0 0 auto;
    }
    .btn-mini{
      border:1px solid rgba(245,196,0,.25);
      background: rgba(245,196,0,.10);
      color: var(--yellow);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }

    /* Modal - custom classes to avoid conflict with .modal in your theme */
    .wmodal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 99999;
      padding: 14px;
    }
    .wmodal{
      width: min(420px, 100%);
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card) 0%, var(--bg-2) 100%);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      padding: 16px;
    }
    .wmodal-title{
      font-weight: 900;
      font-size: 18px;
      margin: 0;
    }
    .wmodal-text{
      margin-top: 10px;
      color: var(--muted);
      font-weight: 800;
      line-height: 1.8;
      white-space: pre-line;
      font-size: 13px;
    }
    .wmodal-actions{
      display:flex;
      gap:10px;
      margin-top: 14px;
    }
    .wbtn-cancel{
      flex:1;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
    }
    .wbtn-ok{
      flex:1;
      border:0;
      background: var(--yellow);
      color:#0a1222;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight: 900;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="mobile-wrap">

    <div class="top-card">
      <div class="badge-icon">ğŸ†</div>

      <div style="margin-top:10px;">
        <div class="page-title">Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§Ø¨Ø­ÙŠÙ†</div>
        <div class="page-subtitle">ØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† / Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
      </div>

      <div class="tabs-wrap">
        <a class="tab-btn {{ 'active' if status_filter=='pending' else '' }}"
           href="{{ url_for('admin_winners', status='pending') }}">ØºÙŠØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†</a>

        <a class="tab-btn {{ 'active' if status_filter=='delivered' else '' }}"
           href="{{ url_for('admin_winners', status='delivered') }}">Ø§Ù„Ù…Ø³ØªÙ„Ù…</a>
      </div>

      <div style="margin-top:10px;">
        <a href="{{ url_for('admin_dashboard') }}" style="color:var(--muted);text-decoration:none;font-weight:800;">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£Ø¯Ù…Ù†</a>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ({{ winners|length }})</div>

      {% if winners|length == 0 %}
        <div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ±.</div>
      {% endif %}

      {% for w in winners %}
        <div class="quick-item" style="text-align:right;">
          <div class="winner-row">

            <!-- thumb using your theme class -->
            <div class="gift-thumb">
              {% set img = gift_image_url(w.image_filename) if w.image_filename else None %}
              {% if img %}
                <img src="{{ img }}" alt="gift">
              {% else %}
                <div style="width:72px;height:72px;display:flex;align-items:center;justify-content:center;opacity:.6;">ğŸ</div>
              {% endif %}
            </div>

            <div class="winner-info">
              <div class="winner-name">ğŸ‘¤ {{ w.tech_name }}</div>
              <div class="winner-line">ğŸ {{ w.gift_name }}</div>
              <div class="winner-line">ğŸ“… {{ w.won_at }}</div>

              {% if (w.status or 'pending') == 'delivered' %}
                <div class="status-pill delivered">âœ… Ù…Ø³ØªÙ„Ù…</div>
              {% else %}
                <div class="status-pill pending">â³ ØºÙŠØ± Ù…Ø³ØªÙ„Ù…</div>
              {% endif %}
            </div>

            {% if (w.status or 'pending') == 'pending' %}
              <div class="winner-actions">
                <!-- fixed action form (no hanging / no JS action changes) -->
                <form id="deliverForm{{ w.redemption_id }}"
                      method="post"
                      action="{{ url_for('admin_mark_delivered', redemption_id=w.redemption_id) }}"></form>

                <button class="btn-mini" type="button"
                        onclick="openConfirm('{{ w.redemption_id }}','{{ w.tech_name|e }}','{{ w.gift_name|e }}')">
                  ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
                </button>
              </div>
            {% endif %}

          </div>
        </div>
      {% endfor %}
    </div>

  </div>

  <!-- Custom Modal (no conflict with your .modal class) -->
  <div id="wmodalBackdrop" class="wmodal-backdrop" onclick="closeConfirm(event)">
    <div class="wmodal" onclick="event.stopPropagation()">
      <h3 class="wmodal-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h3>
      <div id="wmodalText" class="wmodal-text"></div>
      <div class="wmodal-actions">
        <button class="wbtn-cancel" type="button" onclick="hideModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="wbtn-ok" type="button" onclick="submitDeliver()">Ù†Ø¹Ù…ØŒ ØªØ£ÙƒÙŠØ¯</button>
      </div>
    </div>
  </div>

  <script>
    let targetId = null;

    function openConfirm(id, techName, giftName){
      targetId = id;
      document.getElementById('wmodalText').textContent =
        `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…ØŸ\n\nØ§Ù„Ø±Ø§Ø¨Ø­: ${techName}\nØ§Ù„Ù‡Ø¯ÙŠØ©: ${giftName}`;
      document.getElementById('wmodalBackdrop').style.display = 'flex';
    }

    function hideModal(){
      document.getElementById('wmodalBackdrop').style.display = 'none';
      targetId = null;
    }

    function closeConfirm(e){
      if(e.target.id === 'wmodalBackdrop') hideModal();
    }

    function submitDeliver(){
      if(!targetId) return;
      const f = document.getElementById('deliverForm' + targetId);
      if(f) f.submit();
    }
  </script>
</body>
</html>
